---
title: async awaitってどうやって使うの？？？
published: 2019-07-30
tags: ["Archive","Android",ReactNative,Program,Javascript]
category: Diary
draft: false
---


<div>自分へのメモのために投下。</div><div>async awaitの簡単な仕組み<div style="color: #fdfdfd;background-color: #272727;font-family: 'Droid Sans Mono', 'monospace', monospace, 'Droid Sans Fallback';font-weight: normal;font-size: 16px;line-height: 22px;white-space: pre;"><div><span style="color: rgb(0, 182, 203);">async</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(0, 182, 203);">function</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(137, 162, 246);">test</span><span style="color: rgb(216, 216, 216);">(){</span></div></div></div><div>で起動。まぁ無名関数でもなんでもいいのかもしれない。とにかくasyncを頭につけたfunctionの波括弧内に普通の独自関数みたいに記述していく。</div><div>このasyncの中でのみ、特殊なawaitが使えるようになる。</div><div><div style="color: #fdfdfd;background-color: #272727;font-family: 'Droid Sans Mono', 'monospace', monospace, 'Droid Sans Fallback';font-weight: normal;font-size: 16px;line-height: 22px;white-space: pre;"><div><span style="color: rgb(0, 182, 203);">const</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">update</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(199, 182, 247);">=</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(252, 175, 109);">await</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">Updates</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">checkForUpdateAsync</span><span style="color: rgb(253, 253, 253);">()</span><span style="color: rgb(216, 216, 216);">;</span></div></div></div><div>このawaitの本来の使い方は普通の変数として要素を宣言する時に代入値側にawaitを頭につけた代入をするとこのデータがnullであったとしてもエラーを吐かずに待機してくれるものらしい。データが入るまでは応答しない、ということか。そしてデータが入った後でようやく実行するようになる。</div><div>同じように代入に限らず処理にも当てることができるらしく、したい処理の前にawaitを付加したらそれが実行が完了するまで待機してくれるようだ。その処理の後に.then(function(){処理内容})を付加すれば、「処理が完了した後にこの処理をする」というものができる。</div><div><div style="color: #fdfdfd;background-color: #272727;font-family: 'Droid Sans Mono', 'monospace', monospace, 'Droid Sans Fallback';font-weight: normal;font-size: 16px;line-height: 22px;white-space: pre;"><div><span style="color: rgb(252, 175, 109);">await</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">Updates</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">fetchUpdateAsync</span><span style="color: rgb(253, 253, 253);">()</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">then</span><span style="color: rgb(253, 253, 253);">(</span><span style="color: rgb(0, 182, 203);">function</span><span style="color: rgb(216, 216, 216);">(){</span></div></div></div><div>このような実装が必要だったのが、reactnative/expoのデータ自動更新の確認作業だった。</div><br><br><div>expoのデータ更新のために必要な作業</div><div><ol><li>expoのサーバーへ更新確認</li><li>更新を確認したらそれをダウンロード</li><li>ダウンロードしたら再起動して適用</li></ol>expoのデータサーバーへ瞬時にはロードできないがロードできないわけではない。</div><div>ロードしてからでないと話は進まない。ダウンロードしてからでないと再起動しても意味が無い。</div><br><div>つまり、この3つの処理は必ず前の処理が完了してからでないとダメ。データの読み込みが完了しなければ意味が無いのだ。</div><div>こうして設計されたコードがこちら。<br></div><div><div style="color: #fdfdfd;background-color: #272727;font-family: 'Droid Sans Mono', 'monospace', monospace, 'Droid Sans Fallback';font-weight: normal;font-size: 16px;line-height: 22px;white-space: pre;"><div><span style="color: rgb(0, 182, 203);">async</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(0, 182, 203);">function</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(137, 162, 246);">test</span><span style="color: rgb(216, 216, 216);">(){</span></div><div><span style="color: rgb(253, 253, 253);">              </span><span style="color: rgb(0, 182, 203);">const</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">update</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(199, 182, 247);">=</span><span style="color: rgb(253, 253, 253);"> </span><span style="color: rgb(252, 175, 109);">await</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">Updates</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">checkForUpdateAsync</span><span style="color: rgb(253, 253, 253);">()</span><span style="color: rgb(216, 216, 216);">;</span></div><div><span style="color: rgb(253, 253, 253);">              </span><span style="color: rgb(252, 175, 109);">if</span><span style="color: rgb(253, 253, 253);"> (</span><span style="font-weight: bold; color: rgb(240, 113, 120);">update</span><span style="color: rgb(216, 216, 216);">.</span><span style="font-weight: bold; color: rgb(240, 113, 120);">isAvailable</span><span style="color: rgb(253, 253, 253);">) </span><span style="color: rgb(216, 216, 216);">{</span></div><div><span style="color: rgb(253, 253, 253);">                    </span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">showWithGravityAndOffset</span><span style="color: rgb(253, 253, 253);">(</span><span style="color: rgb(216, 216, 216);">'</span><span style="color: rgb(137, 237, 160);">更新データがあります。ダウンロード、更新が完了するまでお待ちください。</span><span style="color: rgb(216, 216, 216);">'</span><span style="color: rgb(216, 216, 216);">,</span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="font-weight: bold; color: rgb(240, 113, 120);">LONG</span><span style="color: rgb(216, 216, 216);">,</span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="font-weight: bold; color: rgb(240, 113, 120);">BOTTOM</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(221, 221, 221);">25</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(221, 221, 221);">50</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(253, 253, 253);">)</span><span style="color: rgb(216, 216, 216);">;</span></div><div><span style="color: rgb(253, 253, 253);">                    </span><span style="color: rgb(252, 175, 109);">await</span><span style="color: rgb(253, 253, 253);"> </span><span style="font-weight: bold; color: rgb(240, 113, 120);">Updates</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">fetchUpdateAsync</span><span style="color: rgb(253, 253, 253);">()</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">then</span><span style="color: rgb(253, 253, 253);">(</span><span style="color: rgb(0, 182, 203);">function</span><span style="color: rgb(216, 216, 216);">(){</span></div><div><span style="color: rgb(253, 253, 253);">                        </span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">showWithGravityAndOffset</span><span style="color: rgb(253, 253, 253);">(</span><span style="color: rgb(216, 216, 216);">'</span><span style="color: rgb(137, 237, 160);">ダウンロードが完了しました。再起動します。</span><span style="color: rgb(216, 216, 216);">'</span><span style="color: rgb(216, 216, 216);">,</span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="font-weight: bold; color: rgb(240, 113, 120);">LONG</span><span style="color: rgb(216, 216, 216);">,</span><span style="font-weight: bold; color: rgb(240, 113, 120);">ToastAndroid</span><span style="color: rgb(216, 216, 216);">.</span><span style="font-weight: bold; color: rgb(240, 113, 120);">BOTTOM</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(221, 221, 221);">25</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(221, 221, 221);">50</span><span style="color: rgb(216, 216, 216);">,</span><span style="color: rgb(253, 253, 253);">)</span><span style="color: rgb(216, 216, 216);">;</span></div><div><span style="color: rgb(253, 253, 253);">                        </span><span style="font-weight: bold; color: rgb(240, 113, 120);">Updates</span><span style="color: rgb(216, 216, 216);">.</span><span style="color: rgb(137, 162, 246);">reload</span><span style="color: rgb(253, 253, 253);">()</span><span style="color: rgb(216, 216, 216);">;</span></div><div><span style="color: rgb(253, 253, 253);">                    </span><span style="color: rgb(216, 216, 216);">}</span><span style="color: rgb(253, 253, 253);">)</span><span style="color: rgb(216, 216, 216);">;</span></div><div><span style="color: rgb(253, 253, 253);">                    </span></div><div><span style="color: rgb(253, 253, 253);">                </span><span style="color: rgb(216, 216, 216);">}</span></div><div><span style="color: rgb(253, 253, 253);">                </span><span style="color: rgb(252, 175, 109);">else</span><span style="color: rgb(216, 216, 216);">{</span></div><div><span style="color: rgb(253, 253, 253);">                </span><span style="color: rgb(216, 216, 216);">}</span></div><div><span style="color: rgb(253, 253, 253);">            </span><span style="color: rgb(216, 216, 216);">}</span></div></div></div><div>まず行で順に見ていこう。</div><div>asyncのつけたfunctionのtestが今回の自作関数だ。</div><div>Updates.checkForUpdateAsyncが、サーバーにアップデート確認する処理。この結果を変数に返すので、update.isAvailableがtrueになれば更新アリ、そうでなければナシなif分岐が作成できる。</div><div>Toastはただの告知だから無視して、Updates.fetchUpdateAsync()でデータの取得ができる。その取得にawaitで待機させた後、.thenを噛ませることで「アップデート後の情報を取得したのを確認した後中のfunctionを実行する」ということが可能となる。</div><div>で、そのfunctionの中身だが、Updates.reload();だけ。これで中身の再起動がされる。外面的にはアプリがクラッシュして再起動したようにも見えるのでここはちゃんと告知が必要かもしれない。</div><br><div>もし、ここでawaitとthenを使わずにやろうとしたらどうなるのか気になるだろうが、ダウンロードが完了する前に再起動が掛かって無限クラッシュループに陥ってしまった。</div><div>処理の指示して終了するのと、処理してから結果が出るのはまた違うようだ。</div><div>それと冒頭のawaitをしなければ、if分岐がNullPointExceptionを吐くのは間違いないだろう。</div><div>tryしてればよさそうにも一瞬感じるが.....まぁ、それは考え方がそもそも違うのでここでは気にしない方針でいく。</div><br><div>あ、一番重要なことだけど、今回は自作関数なので実行するために記述が必須。どこでもいいので</div><div><div style="color: #fdfdfd;background-color: #272727;font-family: 'Droid Sans Mono', 'monospace', monospace, 'Droid Sans Fallback';font-weight: normal;font-size: 16px;line-height: 22px;white-space: pre;"><div><span style="color: #89a2f6;">test</span><span style="color: #fdfdfd;">()</span><span style="color: #d8d8d8;">;</span></div></div></div><div>の記述をお忘れなく。<br></div><br><div>さて、説明しているサイトも個人的にはかなり難しく感じたので自分が使う最低限な概念をピックアップして紹介してみたがどうだろう、わかりやすかっただろうか？？ではまた〜〜。<br></div><br>
