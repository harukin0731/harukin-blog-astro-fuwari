---
title: ArchlinuxのhomeディレクトリのWindowsとの共有
published: 2019-02-11
tags: ["Archive","Linux","Windows","ArchLinux"]
category: Diary
draft: false
---

<div>LinuxとWindowsをデュアルブートしている人なら誰でも思うことがあるかもしれない疑問がある。</div><div>それは"<b>WindowsのUserディレクトリとLinuxのhomeディレクトリ同居できないのか</b>"という問題。</div><div>前から自分はずっとそれを思っており、パーティションも/bootと/と/homeとWindowsと別れているのが鬱陶しかった。LinuxからWindowsのファイルを参照することは容易かもしれないがWindowsからLinuxのパーティションを参照するのはちょっと面倒。というより、ユーザーデータ保存のディレクトリをあちこちに作られたら管理が面倒なのだ。</div><br><div>新しいPCがきた。</div><br><div>やるか。</div><br><div>これは私が後日再構築しようと思ったときにすぐできるように、とのメモ書きである。</div><br><div><b>目標</b></div><div><b>1 UEFI環境でのArchとWindowsのデュアルブート</b></div><div><b>2 使用ディレクトリは既存のWindows環境に/ディレクトリのためのパーティションを作成するだけ</b></div><div><b>3 Windowsの C:user\ とArchの /home/ を同じディレクトリにする</b></div><div><b></b><br></div><br><div><b>1 パーティションを分ける</b></div><div>当該のマシンは次のパーティション構造になっていた。</div><div><b>&nbsp;</b> 1 EFIパーティション</div><div>&nbsp; 2 Windows予約領域</div><div>&nbsp; 3 Cドライブ</div><div>&nbsp; 4 回復パーティション(WinRE)</div><div>&nbsp; 5 Dドライブ</div><div>&nbsp; 6 謎(BIOS-RVY)</div><br><div>まずは使わないDを潰してCを拡張、その後ろにArchのインストール領域を作ろうと考えた。</div><div><div><b>&nbsp;</b> 1 EFIパーティション</div><div>&nbsp; 2 Windows予約領域</div><div>&nbsp; 3 Cドライブ</div><div>&nbsp; 4 Archインストールエリア<br></div><div>&nbsp; 5 回復パーティション(WinRE)</div><div>&nbsp; 6 謎(BIOS-RVY)</div><div><a href="https://www.disk-partition.com/jp/" target="_blank">Aomei Partition Assistant</a></div><div>↑このソフトでDの消去、回復パーティションの後移動、Cのリサイズをして80GBの空領域を作成してもらった。オススメ。<br></div></div><div><b><br></b></div><div><b> 2 Archlinuxを普通にインストール</b></div><br><div>なんてことない、普通にインストールするだけ。</div><div><a href="https://wiki.archlinux.jp/index.php/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%AC%E3%82%A4%E3%83%89" target="_blank">公式インストールガイド</a></div><div>途中詰まったのがネットワーク、このマシンは有線LANが無いので<a href="https://wiki.archlinux.jp/index.php/Android_%E3%83%86%E3%82%B6%E3%83%AA%E3%83%B3%E3%82%B0#USB_.E3.83.86.E3.82.B6.E3.83.AA.E3.83.B3.E3.82.B0" target="_blank">こちら</a>を参照してスマホのUSBテザリングで突破した。</div><div>上での4のエリアをext4でフォーマット、/mntに4、/mnt/bootに1をマウントしてgenfstabとpacstrap。</div><div>ブートローダーはreFindを使った。UIがいいね。</div><br><div><b>3 /homeを\userにリンクさせる</b></div><div>ここが鬼門だった。ここに書いてることは対したことはないのだがこれに行き付くまでがw</div><div>普通にマウントしてもLinuxカーネル自体はNTFSは読み込み専用でしか対応してくれないので<a target="_blank" href="https://wiki.archlinux.jp/index.php/NTFS-3G">NTFS-3G</a>をインストール。ついでに<a target="_blank" href="https://qiita.com/Gen_Arch/items/ad7aef73cfc5a12b4e45">yayもインストール。</a></div><div>次に、読み書きできるようになったNTFSをマウントさせる。</div><div>/run/media/Windowsフォルダを作成して3をマウント、/run/media/Windows/Usersを/homeにバインドマウント</div><div>一応fstabを書いておこう。<br></div><blockquote><div>/dev/nvme0n1p3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /run/media/Windows ntfs-3g uid=harukin,gid=harukin 0 0<br>/run/media/Windows/Users /home&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; none&nbsp;&nbsp;&nbsp; bind&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 0</div></blockquote><div>uidやgidは本来あまり関係無いけど、後にwineを入れる時に障壁となったので。</div><div>uidgidはutfs-3g固有のオプションらしくマウントしたNTFSディレクトリの所有ユーザーを指定できるもの。既定ではroot:rootになっていて、NTFSのファイルシステムなので変更ができない(chownしてもエラーこそ吐かなくても無効になる)。root:rootでもアクセス書き込みはできるから実用には問題はないが、ユーザー固有のものでないとwineがエラー吐いて導入させてくれなかったので後に追加した。</div><div>理解できる人は理解できると思うけども、これはLinuxを使うのが独りである、という場合のみにしか使えない技。</div><br><div><b>4 Linuxユーザーの作成</b></div><div><a target="_blank" href="https://wiki.archlinux.jp/index.php/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E7%AE%A1%E7%90%86%E3%81%AE%E4%BB%96%E3%81%AE%E4%BE%8B">ここ</a>を参考にしてWindowsディレクトリと同じフォルダを指定してユーザー作成。ただ、フォルダ名と同じユーザー名にすれば勝手に同じフォルダになる(=WindowsのユーザーディレクトリがそのままLinuxのホームディレクトリになる)。</div><br><br><div>あとはGUIなどお好きに導入して終了。</div><div>一部NTFSであることの障壁などはあるが大体問題無く運用できている。</div><div>ただ、ドキュメントとかミュージックとかのフォルダがファイルマネージャー(caja)に反映されないのがなんとかならないかなぁってところ。これはWindowsのフォルダをそのまま使用しているからだけども。</div><br><div>この仕組みを使っていることで、わざわざユーザーファイルの居場所を考えることや分裂した容量に頭を悩ませることがなくなり楽になったかな。Archで作業しかけてた項目が当たり前のようにWindowsでも同じ場所にあるってまぁまぁ精神的に楽なもんだ。それまではデータをもう一つのディレクトリにコピペしなきゃならんかったり移動が面倒だったりしたからね。</div><br><div>そんな感じ。</div><br><div>追記:</div><div>sshで暗号鍵認証する時にどうしても権限が問題になってしまったのでちょっと強引だけど</div><div>/root/.sshの中にファイル作成、/rootのアクセスを許可、/root/.sshの所有者を対象ユーザーに変更、/root/.sshを普通のように権限設定して対象ユーザーの.sshにリンクを張ってなんとかした。あまり推奨できるもんではないってことはわかるね！！<br></div>
